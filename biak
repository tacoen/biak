<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Layanan Publik Biak Numfor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- Header -->
    <header class="bg-blue-700 text-white py-8 px-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold">Portal Biak Numfor</h1>
                <p class="text-blue-100">Pencarian Kantor OPD, Distrik, Kelurahan, & Puskesmas</p>
            </div>
            <div class="flex gap-2">
                <button onclick="syncData()" id="syncBtn" class="bg-blue-500 hover:bg-blue-400 px-6 py-2 rounded-full font-semibold transition flex items-center gap-2">
                    <span id="syncIcon">üîÑ</span> Sinkronisasi Google Map
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- Filter Kategori -->
        <div class="flex flex-wrap gap-3 mb-8">
            <button onclick="filterCategory('all')" class="cat-btn active bg-blue-600 text-white px-5 py-2 rounded-lg shadow">Semua</button>
            <button onclick="filterCategory('OPD')" class="cat-btn bg-white text-slate-700 px-5 py-2 rounded-lg shadow hover:bg-blue-50">Kantor OPD</button>
            <button onclick="filterCategory('Distrik')" class="cat-btn bg-white text-slate-700 px-5 py-2 rounded-lg shadow hover:bg-blue-50">Kantor Distrik</button>
            <button onclick="filterCategory('Kelurahan')" class="cat-btn bg-white text-slate-700 px-5 py-2 rounded-lg shadow hover:bg-blue-50">Kelurahan</button>
            <button onclick="filterCategory('Puskesmas')" class="cat-btn bg-white text-slate-700 px-5 py-2 rounded-lg shadow hover:bg-blue-50">Puskesmas</button>
        </div>

        <!-- Konten Utama -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Daftar Lokasi -->
            <div class="lg:col-span-2 space-y-4">
                <div id="loadingStatus" class="hidden p-4 bg-yellow-100 text-yellow-800 rounded-lg animate-pulse">
                    Sedang mencari data terbaru dari Google Map...
                </div>
                <div id="locationList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Data akan muncul di sini -->
                </div>
            </div>

            <!-- Form Tambah/Update Manual -->
            <div class="lg:col-span-1">
                <div class="glass p-6 rounded-2xl shadow-xl sticky top-8 border border-slate-200">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span>üìù</span> Perbarui Data
                    </h2>
                    <form id="updateForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-600">Nama Kantor/Tempat</label>
                            <input type="text" id="nameInput" required class="w-full p-2 border border-slate-300 rounded-lg mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600">Kategori</label>
                            <select id="categoryInput" class="w-full p-2 border border-slate-300 rounded-lg mt-1">
                                <option value="OPD">Kantor OPD</option>
                                <option value="Distrik">Kantor Distrik</option>
                                <option value="Kelurahan">Kelurahan</option>
                                <option value="Puskesmas">Puskesmas</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600">Alamat</label>
                            <textarea id="addressInput" rows="2" class="w-full p-2 border border-slate-300 rounded-lg mt-1"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition">
                            Simpan ke Daftar
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Gunakan string kosong, sistem akan menyuntikkan kunci saat runtime
        const apiKey = ""; 
        let localData = JSON.parse(localStorage.getItem('biak_portal_data')) || [];
        let currentFilter = 'all';

        // Inisialisasi data awal jika kosong
        if (localData.length === 0) {
            localData = [
                { id: 1, name: "Dinas Kesehatan Biak Numfor", category: "OPD", address: "Jl. Majapahit, Biak", source: "Sistem" },
                { id: 2, name: "Puskesmas Biak Kota", category: "Puskesmas", address: "Jl. Imam Bonjol, Biak", source: "Sistem" },
                { id: 3, name: "Kantor Distrik Biak Kota", category: "Distrik", address: "Biak Kota", source: "Sistem" }
            ];
            saveData();
        }

        function saveData() {
            localStorage.setItem('biak_portal_data', JSON.stringify(localData));
            renderData();
        }

        function renderData() {
            const list = document.getElementById('locationList');
            list.innerHTML = '';

            const filtered = currentFilter === 'all' 
                ? localData 
                : localData.filter(item => item.category === currentFilter);

            if (filtered.length === 0) {
                list.innerHTML = `<div class="col-span-full p-8 text-center text-slate-400 italic">Tidak ada data ditemukan. Klik sinkronisasi untuk mencari.</div>`;
                return;
            }

            filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold uppercase tracking-wider px-2 py-1 rounded bg-blue-100 text-blue-700">${item.category}</span>
                        <button onclick="deleteItem(${item.id})" class="text-slate-300 hover:text-red-500 text-sm">Hapus</button>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800">${item.name}</h3>
                    <p class="text-sm text-slate-500 mt-2 flex items-start gap-2">
                        <span>üìç</span> ${item.address || 'Alamat tidak tersedia'}
                    </p>
                    <div class="mt-4 pt-3 border-t border-slate-50 flex justify-between items-center">
                        <span class="text-[10px] text-slate-400">Sumber: ${item.source}</span>
                        <a href="https://www.google.com/maps/search/${encodeURIComponent(item.name + ' Biak Numfor')}" target="_blank" class="text-xs text-blue-600 font-semibold hover:underline">Buka Maps ‚Üí</a>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function filterCategory(cat) {
            currentFilter = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'shadow');
                btn.classList.add('bg-white', 'text-slate-700');
            });
            event.target.classList.add('bg-blue-600', 'text-white', 'shadow');
            renderData();
        }

        const sleep = (ms) => new Promise(res => setTimeout(res, ms));

        async function syncData() {
            const btn = document.getElementById('syncBtn');
            const loading = document.getElementById('loadingStatus');
            btn.disabled = true;
            loading.classList.remove('hidden');
            
            // Query pencarian dengan Google Grounding
            const prompt = "Temukan daftar kantor OPD, kantor distrik, kelurahan, dan puskesmas di Kabupaten Biak Numfor. Berikan hasil dalam format JSON array of objects dengan field: name, category (OPD/Distrik/Kelurahan/Puskesmas), dan address.";

            let success = false;
            let retries = 5;
            let delay = 1000;

            while (retries > 0 && !success) {
                try {
                    // Endpoint resmi yang didukung dengan model spesifik
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ 
                                parts: [{ text: prompt }] 
                            }],
                            tools: [{ "google_search": {} }],
                            generationConfig: { 
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            name: { type: "STRING" },
                                            category: { type: "STRING" },
                                            address: { type: "STRING" }
                                        },
                                        required: ["name", "category", "address"]
                                    }
                                }
                            }
                        })
                    });

                    if (response.status === 401) {
                        throw new Error("Autentikasi gagal (401). Pastikan kunci API valid atau lingkungan mendukung injeksi otomatis.");
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP Error: ${response.status}`);
                    }

                    const result = await response.json();
                    const textContent = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!textContent) throw new Error("Format respons tidak valid");

                    const newData = JSON.parse(textContent);

                    if (Array.isArray(newData)) {
                        newData.forEach(newItem => {
                            const exists = localData.some(d => d.name.toLowerCase() === newItem.name.toLowerCase());
                            if (!exists) {
                                localData.push({
                                    id: Date.now() + Math.random(),
                                    ...newItem,
                                    source: "Google Map Sync"
                                });
                            }
                        });
                        saveData();
                        success = true;
                    }

                } catch (error) {
                    console.error(`Gagal sinkronisasi: ${error.message}`);
                    retries--;
                    if (retries === 0) {
                        showErrorMessage(error.message.includes("401") 
                            ? "Kunci API tidak valid atau belum diset. Harap hubungi administrator." 
                            : "Gagal menghubungkan ke layanan Google Maps.");
                    } else {
                        await sleep(delay);
                        delay *= 2;
                    }
                }
            }

            btn.disabled = false;
            loading.classList.add('hidden');
        }

        function showErrorMessage(msg) {
            const errorBox = document.createElement('div');
            errorBox.className = "fixed bottom-4 right-4 bg-red-600 text-white p-4 rounded-lg shadow-xl z-50 transition-opacity duration-500 max-w-sm";
            errorBox.innerHTML = `<div class="font-bold mb-1">Kesalahan</div><div>${msg}</div>`;
            document.body.appendChild(errorBox);
            setTimeout(() => {
                errorBox.style.opacity = '0';
                setTimeout(() => errorBox.remove(), 500);
            }, 5000);
        }

        document.getElementById('updateForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const newItem = {
                id: Date.now(),
                name: document.getElementById('nameInput').value,
                category: document.getElementById('categoryInput').value,
                address: document.getElementById('addressInput').value,
                source: "User Update"
            };
            localData.unshift(newItem);
            saveData();
            e.target.reset();
        });

        function deleteItem(id) {
            localData = localData.filter(item => item.id !== id);
            saveData();
        }

        renderData();
    </script>
</body>
</html>
